# 阶段4：辩论管理器

## 目标
实现Athens系统的核心辩论流程控制，包括轮次管理、观察模式实现和基础测试功能。

## 具体任务

### 4.1 辩论流程控制
实现 `src/core/debate_manager.py`：
- 协调逻辑者和怀疑者的对话
- 管理辩论的开始、进行和结束
- 控制发言轮次和时间
- 处理辩论状态转换

核心功能：
```python
class DebateManager:
    def __init__(self, logician, skeptic, topic)
    def start_debate(self, initial_statement: str)
    def process_round(self) -> bool  # 返回是否继续
    def pause_debate(self)
    def resume_debate(self)
    def end_debate(self)
    def get_debate_status(self)
```

辩论状态：
- `PREPARING`: 准备阶段
- `ACTIVE`: 进行中
- `PAUSED`: 暂停
- `COMPLETED`: 已完成
- `ABORTED`: 已中止

### 4.2 轮次管理
实现轮次控制逻辑：
- 交替发言机制
- 发言时间限制
- 轮次计数和限制
- 发言质量评估

轮次规则：
- 逻辑者先发言阐述观点
- 怀疑者针对性质疑
- 逻辑者回应质疑
- 循环进行N轮或达到终止条件

终止条件：
- 达到最大轮次数
- 双方达成共识
- 用户主动终止
- 系统异常中断

### 4.3 观察模式实现
实现场景1（纯观察模式）：
- 用户提供初始话题
- AI自动进行多轮辩论
- 实时显示辩论进展
- 最终生成辩论报告

观察模式特性：
- 全自动化流程
- 智能终止判断
- 进度可视化
- 中途可暂停观察

### 4.4 基础测试功能
实现基础的辩论测试：
- 模拟简单话题辩论
- 验证轮次控制正确性
- 测试异常情况处理
- 检查消息传递完整性

测试场景：
- 正常辩论流程
- 异常中断恢复
- 边界条件测试
- 性能压力测试

## 文件清单
需要创建的文件：
- [ ] src/core/debate_manager.py
- [ ] src/core/debate_states.py
- [ ] tests/test_debate_manager.py
- [ ] examples/simple_debate.py

需要修改的文件：
- [ ] src/core/__init__.py (导出辩论管理器)
- [ ] src/main.py (集成辩论管理器)

## 测试方法
1. 辩论管理器初始化测试
2. 轮次控制逻辑验证
3. 观察模式端到端测试
4. 状态转换正确性检查
5. 异常处理机制测试

## 依赖关系
- **前置条件**：阶段2智能体 + 阶段3消息系统
- **后续阶段**：阶段5用户界面将调用辩论管理器
- **关键输出**：可工作的观察模式辩论

## 验收标准
- ✅ 辩论管理器正确控制流程
- ✅ 轮次管理按规则执行
- ✅ 观察模式完整运行
- ✅ 状态转换正确无误
- ✅ 基础测试全部通过

## 设计要点

### 辩论流程示例
```
1. 初始化：创建逻辑者、怀疑者、话题
2. 开始：逻辑者发出初始论证
3. 轮次1：怀疑者质疑 -> 逻辑者回应
4. 轮次2：怀疑者深度质疑 -> 逻辑者再次论证
5. ...继续N轮
6. 结束：达到终止条件，生成总结
```

### 智能终止判断
- 检测重复论证（内容相似度）
- 识别对话收敛趋势
- 监控发言质量下降
- 支持手动干预终止

### 异常处理策略
- AI服务不可用：暂停并等待恢复
- 网络超时：重试机制
- 无效回应：提示重新生成
- 系统异常：保存状态并安全退出